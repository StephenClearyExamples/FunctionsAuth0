<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Auth0 for Azure Functions!</title>
  <style>
      table {
          border: 1px solid;
      }
      td {
          padding: 7px;
      }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/2.0.3/fetch.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <script src="https://cdn.auth0.com/js/auth0/8.8/auth0.min.js"></script>
</head>

<body>
    <div>
    <button id="btn-call">Call API</button>
    <button id="btn-login">Login</button>
    </div>

    <div id="results">
    </div>

    <script>
        var AUTH0_DOMAIN = 'stephenclearytba.auth0.com'; // Copied from client settings on Auth0 dashboard.
        var AUTH0_CLIENT_ID = 'H21JFEgGqDy6cyrkD5WvnzfFnJ1iTgDr'; // Copied from client settings on Auth0 dashboard.
        var AUTH0_CALLBACK_URL = 'https://stephenclearyexamples.github.io/FunctionsAuth0/'; // Copied from GH Pages settings on GitHub.
        var FUNCTIONS_URL = 'https://stephenclearyauth0.azurewebsites.net/'; // Copied from Azure Functions settings.

        var access_token, id_token; // Normally would be stored in local storage; this simple example just uses vars so you logout when you refresh.

        $('document').ready(function() {
            var webAuth = new auth0.WebAuth({
                domain: AUTH0_DOMAIN, // which Auth0 account this we authenticate with
                clientID: AUTH0_CLIENT_ID, // this web page's client id (the audience for the id_token)
                audience: FUNCTIONS_URL, // the API's identifier (the audience for the access_token)
                redirectUri: AUTH0_CALLBACK_URL, // where the authentication will return to - in this example, it returns to this same page
                responseType: 'token id_token', // request both access_token ("token") and id_token
                scope: 'openid profile email' // include common properties
            });

            // Display our current login status; if there's a tokens in the URL hash, then we've been logged in.
            webAuth.parseHash(function(err, authResult) {
                if (authResult && authResult.accessToken && authResult.idToken) {
                    window.location.hash = '';
                    access_token = authResult.accessToken;
                    id_token = authResult.idToken;
                    $('#results').append('<div>Logged in!</div>');
                } else if (err) {
                    console.log(err);
                    $('#results').append('<div>Error ' + err.error + '</div>');
                } else {
                    $('#results').append('<div>Not logged in.</div>');
                }
            });

            // The login button authorizes with auth0.
            // auth0 will redirect back to this page and append an access token in the URL hash.
            $('#btn-login').click(function(e) {
                e.preventDefault();
                webAuth.authorize();
            });
            
            // The api button calls our Azure Functions API and displays the results.
            $('#btn-call').click(function(e) {
                e.preventDefault();
                var headers = new Headers();
                if (access_token && id_token) {
                    // The access_token is the appropriate way to authenticate with the API.
                    headers.append('Authorization', 'Bearer ' + access_token);

                    // But the id_token has tons of useful info (e.g., email address). So we send that along, too.
                    // This technique is appropriate ***IF AND ONLY IF*** you control the client's private key.
                    // If you have clients with their own keys, then you should *only* take the access_token in your API and then
                    //   use the access_token to call https://%AUTH0_DOMAIN%/userinfo to get the additional info.
                    // This example has a client under our control, so we just pass id_token directly to the API to avoid the extra call.
                    headers.append('X-Additional-Token', id_token); // 'X-Additional-Token' isn't any kind of standard or common practice; it's just something I made up.
                }
                fetch(FUNCTIONS_URL + 'api/hello', { headers: headers })
                    .then(function (response) {
                        console.log(response);
                        if (response.ok) {
                            $('#results').append('<div>API called OK!</div>');
                            response.json().then(function (results) {
                                console.log(results);
                                results.forEach(function (token) {
                                    var table = $('<table/>');
                                    token.forEach(function (claim) {
                                        var tr = $('<tr/>');
                                        tr.append($('<td/>').text(claim.type));
                                        tr.append($('<td/>').text(claim.value));
                                        table.append(tr);
                                    });
                                    $('#results').append(table);
                                });
                            });
                        } else {
                            $('#results').append('<div>API call failed</div>');
                            $('#results').append('<div>Code: ' + response.status + '</div>');
                            $('#results').append('<div>Message: ' + response.statusText + '</div>');
                        }
                    });
            });
        });
    </script>
</body>
</html>